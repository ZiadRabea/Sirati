{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>Sirati | Create New</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{% static 'imgs/alignos.jpeg' %}" type="image/png">
    <link rel="icon" type="image/png" href="{% static 'imgs/logo.png' %}">
    <style>
      /* --- base reset from your file --- */
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: row;
        gap: 20px;
        padding: 20px;
        height: 100vh;
        overflow: auto; /* changed from hidden -> allows page scroll when needed */
        background: #f4f6f8;
      }

      /* Form container: scrollable area that fits inside viewport */
      .form {
        flex: 1;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(18, 38, 63, 0.08);
        padding: 28px;
        overflow-y: auto;

        /* Ensure it fits inside the viewport without being clipped by body padding */
        max-height: calc(100vh - 40px); /* subtract body padding top + bottom (20 + 20) */
        padding-bottom: 110px; /* reserve space so sticky submit doesn't cover last input */
        scroll-padding-bottom: 40px;
      }

      .container {
        flex: 1;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(18, 38, 63, 0.08);
        overflow: hidden;
      }

      iframe { border: none; width: 100%; height: 100%; }
      .form h2 { margin-bottom: 18px; font-weight: 700; color: #12263f; }

      .form label { display:block; font-weight:600; margin-top:14px; color:#2b3948; }
      .form input, .form textarea, .form select { width:100%; padding:10px; margin-top:6px; border:1px solid #e2e8ee; border-radius:8px; font-size:14px; background:#fbfdff; }
      
      /* submit button: sticky so it's always visible within the form's scroll area */
      .form .submit-row {
        position: sticky;
        bottom: 20px; /* distance from bottom of the form scroll area */
        width: 100%;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding-top: 10px;
        background: linear-gradient(transparent, rgba(255,255,255,0.95)); /* subtle fade so last inputs aren't hidden */
      }
      .form button[type="submit"] { 
        display: inline-block; 
        background: linear-gradient(90deg,#2ab27b,#2fa170); 
        color:#fff; 
        border:none; 
        border-radius:10px; 
        padding:10px 16px; 
        font-size:16px; 
        cursor:pointer; 
      }

      /* --- Image uploader styles --- */
      .image-uploader {
        margin-top: 8px;
      }

      /* Hide the default Django file input (we'll re-use it via JS) */
      #id_profile_pic { /* default Django id for field named 'profile_pic' */
        display: none !important;
      }

      .upload-card {
        display: flex;
        gap: 16px;
        align-items: center;
        padding: 12px;
        border-radius: 12px;
        border: 1px dashed rgba(45, 55, 72, 0.12);
        background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(250,252,255,0.8));
        transition: border-color .18s ease, box-shadow .18s ease;
        cursor: pointer;
      }
      .upload-card.dragover {
        border-color: #2ab27b;
        box-shadow: 0 6px 20px rgba(43,178,123,0.12);
      }

      .preview-box {
        width: 88px;
        height: 88px;
        border-radius: 12px;
        overflow: hidden;
        flex: 0 0 88px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg,#f6f9fb,#ffffff);
        border: 1px solid #eef3f7;
      }

      .preview-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .upload-meta {
        flex: 1;
        min-width: 0;
      }
      .upload-meta p {
        margin-bottom: 6px;
        color: #24303f;
        font-weight: 600;
      }
      .upload-actions {
        display:flex;
        gap:8px;
        align-items:center;
        margin-top:4px;
      }
      .btn-ghost {
        border: none;
        background: transparent;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight:600;
        color:#2b3948;
      }
      .btn-primary {
        background: #2ab27b;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
      }
      .file-info { color:#667085; font-size:13px; margin-top:6px; }

      .hidden { display:none !important; }

      @media only screen and (max-width: 950px) {
        body { 
          flex-direction: column; 
          align-items: stretch; 
          padding: 10px; 
        }

        .form { 
          flex: none; 
          width: 100%; 
          /* on small screens allow full viewport height but keep padding-bottom so submit is visible */
          max-height: calc(100vh - 20px);
          padding-bottom: 140px;
        }

        .container { 
          display: none !important; /* hide iframe completely on mobile */
        }

        .upload-card { 
          gap: 12px; 
        }

        .form .submit-row {
          bottom: 12px;
        }
      }
    </style>
  </head>
  <body>
    <form class="form" action="#" method="post" enctype="multipart/form-data" id="createForm">
      {% csrf_token %}
      <h2>Create New</h2>
      <label for="profile_picture">Profile Picture</label>

      <!-- Keep the original Django widget in the template (hidden). JS will connect to it.
            If your field has a different id, adjust FILE_INPUT_ID in the script below. -->
      {{ form.profile_pic }}

      <!-- Custom visually-pleasing uploader -->
      <div class="image-uploader" aria-hidden="false">
        <div id="uploadCard" class="upload-card" tabindex="0" role="button" aria-label="Upload profile picture">
          <div class="preview-box" id="previewBox" aria-hidden="true">
            <!-- show existing image if any -->
            {% if form.instance and form.instance.profile_pic %}
              <img src="{{ form.instance.profile_pic.url }}" alt="Current profile picture" id="previewImg">
            {% else %}
              <!-- placeholder SVG -->
              <img src="{% static 'imgs/default-avatar.png' %}" alt="placeholder" id="previewImg">
            {% endif %}
          </div>

          <div class="upload-meta">
            <p id="metaTitle">Drag & drop an image here, or click <span style="font-weight:800; color:#2ab27b">Browse</span></p>
            <div class="upload-actions">
              <button type="button" id="browseBtn" class="btn-ghost">Browse</button>
              <button type="button" id="removeBtn" class="btn-ghost {% if not form.instance.profile_pic %}hidden{% endif %}">Remove</button>
              <button type="button" id="cropHintBtn" class="btn-ghost">Tip</button>
            </div>
            <div class="file-info" id="fileInfo"><!-- filename + size goes here --></div>
          </div>
        </div>
      </div>

      <label for="age">Birthday</label>
      <input type="date" name="birthday" required>
      <label for="background_image" style="color:darkgray">CV URL</label>
      {{ form.cv_url }}
      <label for="current_job">Job Title</label>
      {{ form.current_job }}
      <label for="email">Email</label>
      {{ form.email }}
      <label for="intro">Self-Introduction</label>
      {{ form.about }}

      <!-- sticky submit row -->
      <div class="submit-row">
        <button type="submit">Submit</button>
      </div>
    </form>

    <div class="container">
      <iframe id="displayframe"></iframe>
    </div>

    <script>
      (function () {
        // Constants — update if your field uses a different id
        const FILE_INPUT_ID = "id_profile_pic"; // Django default if your field name is profile_pic
        const uploadCard = document.getElementById("uploadCard");
        const fileInput = document.getElementById(FILE_INPUT_ID);
        const browseBtn = document.getElementById("browseBtn");
        const removeBtn = document.getElementById("removeBtn");
        const previewImg = document.getElementById("previewImg");
        const fileInfo = document.getElementById("fileInfo");
        const previewBox = document.getElementById("previewBox");

        if (!fileInput) {
          console.warn("Profile picture input not found. Make sure the Django field name is 'profile_pic' or update FILE_INPUT_ID.");
          return;
        }

        const MAX_BYTES = 5 * 1024 * 1024; // 5 MB
        const ACCEPTED_TYPES = /^image\/(png|jpe?g|webp|gif|bmp|svg\+xml)$/i;

        // Helper: pretty file size
        function prettySize(bytes) {
          if (bytes < 1024) return bytes + " B";
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
          return (bytes / (1024 * 1024)).toFixed(2) + " MB";
        }

        // Show file details and preview
        function showFile(file) {
          if (!file) return;
          fileInfo.textContent = file.name + " • " + prettySize(file.size);
          // validation
          if (!ACCEPTED_TYPES.test(file.type)) {
            fileInfo.textContent += " — Unsupported file type";
            fileInfo.style.color = "crimson";
            return;
          }
          if (file.size > MAX_BYTES) {
            fileInfo.textContent += " — File too large (max 5 MB)";
            fileInfo.style.color = "crimson";
            return;
          }
          fileInfo.style.color = "";
          const reader = new FileReader();
          reader.onload = function (e) {
            previewImg.src = e.target.result;
            removeBtn.classList.remove("hidden");
            ensureSubmitVisible(); // keep submit in view if necessary
          };
          reader.readAsDataURL(file);
        }

        // Reset to placeholder or existing server image if present
        function resetPreview() {
          fileInput.value = "";
          fileInfo.textContent = "";
          if (!previewImg.src || previewImg.src.startsWith("data:")) {
            previewImg.src = "{% static 'imgs/default-avatar.png' %}";
          }
          removeBtn.classList.add("hidden");
          ensureSubmitVisible();
        }

        // Click behavior - open file dialog
        browseBtn.addEventListener("click", function (e) {
          e.preventDefault();
          fileInput.click();
        });

        // If the upload card clicked anywhere, open file dialog
        uploadCard.addEventListener("click", function (e) {
          // avoid triggering when clicking the remove or browse buttons (they have their own handlers)
          const target = e.target;
          if (target === removeBtn || target === browseBtn) return;
          fileInput.click();
        });

        // Keyboard accessibility
        uploadCard.addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            fileInput.click();
          }
        });

        // Drag & drop
        ["dragenter", "dragover"].forEach(name => {
          uploadCard.addEventListener(name, (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadCard.classList.add("dragover");
          });
        });
        ["dragleave", "drop"].forEach(name => {
          uploadCard.addEventListener(name, (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadCard.classList.remove("dragover");
          });
        });
        uploadCard.addEventListener("drop", function (e) {
          const dt = e.dataTransfer;
          if (!dt || !dt.files || dt.files.length === 0) return;
          const file = dt.files[0];
          // put it into the hidden file input so form submission works.
          try {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
          } catch (err) {
            console.warn("Couldn't assign dropped file to input programmatically; preview will still work but form may not submit file in this browser.");
          }
          showFile(file);
        });

        // When the actual (hidden) input changes (user selected via dialog)
        fileInput.addEventListener("change", function (e) {
          const f = fileInput.files && fileInput.files[0];
          if (!f) return;
          showFile(f);
        });

        // Remove button clears value + preview
        removeBtn.addEventListener("click", function (e) {
          e.preventDefault();
          resetPreview();
        });

        // small tip button for cropping guidance
        document.getElementById("cropHintBtn").addEventListener("click", function (e) {
          e.preventDefault();
          alert("Tip: upload a square image (e.g. 400×400 px) for the best result. You can also crop in your photo editor before uploading.");
        });

        // Initialize preview state
        (function init() {
          if (previewImg && previewImg.src && !previewImg.src.includes("default-avatar")) {
            removeBtn.classList.remove("hidden");
          } else {
            removeBtn.classList.add("hidden");
          }
        })();

        // helper: ensure submit visible when form content changes
        function ensureSubmitVisible() {
          try {
            const formEl = document.querySelector('.form');
            const btn = document.querySelector('.form button[type="submit"]');
            if (!formEl || !btn) return;
            // scroll so button is visible inside the form scroll container
            btn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          } catch (e) {
            // ignore
          }
        }

        // call ensure submit on resize to help small viewports
        window.addEventListener('resize', ensureSubmitVisible);

      })();
    </script>

    <script>
      // keep this as in your original page
      document.getElementById("displayframe").src = String(window.location.origin) + "/ZiadRabea";
    </script>
  </body>
</html>
