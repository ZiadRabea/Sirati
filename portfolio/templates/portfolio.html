{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sirati – Portfolio</title>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    /* Base */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    html,body { height: 100%; }
    body { background: #0e0e0e; color: #fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; overflow-x:hidden; }

    /* Hero */
    .hero { height: 100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background: radial-gradient(circle at 30% 30%, #222, #000); position:relative; text-align:center; padding: 40px 20px; }
    .hero img { width:150px;height:150px;border-radius:50%;margin-bottom:20px;opacity:0;animation:fadeUp .8s ease forwards; object-fit:cover; border: 3px solid rgba(255,255,255,0.04); }
    .hero h1 { font-size:4rem; font-weight:800; letter-spacing: -1px; opacity:0; animation:fadeUp 1s ease forwards; }
    .hero p { margin-top:12px; font-size:1.15rem; opacity:0; animation:fadeUp 1.3s ease forwards; color:#cfcfcf; }
    .hero a, .skills a { display:inline-block;margin-top:20px;padding:12px 30px;background:#111;border:1px solid #444;color:white;border-radius:10px;text-decoration:none;font-size:1.05rem; transition: transform .18s ease, box-shadow .18s ease; }
    .skills a {display: block; width: 100%; text-align: center;}
    .hero a:hover, .skills a:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.6); }

    @keyframes fadeUp { 0% { opacity:0; transform: translateY(20px);} 100% { opacity:1; transform: translateY(0);} }

    /* Sections */
    .section-title { text-align:center; font-size:2.5rem; margin:80px 0 40px; font-weight:700; color:#f7f7f7; }
    .services { display:grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap:20px; width:90%; margin: auto; }
    .card { background:#1a1a1a; padding:25px; border-radius:16px; transition: transform .25s ease, box-shadow .25s ease; border:1px solid #333; }
    .card:hover { transform: translateY(-8px); box-shadow: 0 0 40px rgba(255,255,255,0.03); }

    .timeline { width:90%; margin:80px auto; border-left:2px solid #444; padding-left:30px; }
    .milestone { margin-bottom:40px; position:relative; color:#dcdcdc; }
    .milestone::before { content:""; width:18px;height:18px;background:#fff;border-radius:50%;position:absolute;left:-40px;top:0; box-shadow: 0 0 10px rgba(255,255,255,0.03); }

    .projects { display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:25px; width:90%; margin: auto; }
    .project-card { background:#141414; border:1px solid #333; padding:20px; border-radius:14px; transition: transform .2s ease, box-shadow .2s ease; }
    .project-card:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(255,255,255,0.04); }

    .cta { text-align:center; margin:80px 0 120px; }

    /* Floating icons */
    .float-icon { width:18px;height:18px;border-radius:50%;background:#0a0a0a; transition: background .25s, box-shadow .25s, transform .18s; cursor:pointer; border:1px solid rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:center; }
    .float-icon.active { background: #00f2ff; box-shadow: 0 0 12px #00f2ff; transform: scale(1.08); }
    .float-icon:focus { outline: 2px solid rgba(124,92,255,0.6); outline-offset: 3px; }

    /* ---------------------------
       Skills (progress bars)
       --------------------------- */
    .skills { width:90%; margin: 0 auto 40px; max-width: 900px; }
    .skill { margin-bottom: 18px; }
    .skill .label-row { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px; }
    .skill .label-row .name { font-weight:600; color:#eaeaea; }
    .skill .label-row .percent { font-size:0.95rem; color:#bfbfbf; min-width:46px; text-align:right; }

    .progress { background: linear-gradient(90deg,#262626,#1a1a1a); height:14px; border-radius:10px; overflow:hidden; position:relative; border:1px solid rgba(255,255,255,0.03); }
    .progress .bar {
      height:100%;
      width:0%;
      border-radius:10px;
      background:
        linear-gradient(90deg, rgba(255,255,255,0.08), rgba(255,255,255,0.06)),
        linear-gradient(120deg, #00f2ff 0%, #7c5cff 55%, #ff66b3 100%);
      transform-origin: left center;
      transition: width 1.1s cubic-bezier(.22,.9,.32,1);
      position:relative;
      overflow:hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6) inset;
      will-change: width; /* hint to browser for smoother anim */
    }

    /* animated stripe overlay */
    .progress .bar::after {
      content:"";
      position:absolute;
      inset:0;
      background-image: linear-gradient(45deg, rgba(255,255,255,0.06) 25%, rgba(255,255,255,0.02) 25%, rgba(255,255,255,0.02) 50%, rgba(255,255,255,0.06) 50%, rgba(255,255,255,0.06) 75%, rgba(255,255,255,0.02) 75%, rgba(255,255,255,0.02) 100%);
      background-size: 40px 40px;
      mix-blend-mode: overlay;
      animation: stripes 2s linear infinite;
      pointer-events:none;
      opacity:0.55;
    }
    @keyframes stripes { from { background-position: 0 0; } to { background-position: 40px 0; } }

    /* subtle glow trailing the bar */
    .progress .bar::before {
      content:"";
      position:absolute;
      right: -30px;
      top: -25%;
      width:60px;
      height:150%;
      filter: blur(20px);
      background: radial-gradient(closest-side, rgba(255,255,255,0.08), rgba(255,255,255,0) 60%);
      opacity:0.5;
      transform: translateX(0);
      transition: transform 1.1s cubic-bezier(.22,.9,.32,1);
      pointer-events:none;
    }

    /* When filled, make the glow stick to the right edge by moving it */
    .bar-filled::before { transform: translateX(calc(-1 * (100% - var(--target-offset, 100%)))); }

    /* ---------------------------
       Contact form (elegant)
       --------------------------- */
    .contact-card {
      width: min(720px, 92%);
      margin: 0 auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 16px;
      padding: 28px;
      display:flex;
      gap:28px;
      align-items:flex-start;
      justify-content:space-between;
      border: 1px solid rgba(124,92,255,0.12);
      box-shadow: 0 6px 40px rgba(0,0,0,0.6);
      backdrop-filter: blur(6px);
    }

    .contact-left { flex: 1 1 280px; }
    .contact-right { width: 360px; max-width: 45%; }

    .contact-card h3 { font-size:1.35rem; margin-bottom:8px; }
    .contact-card p.lead { color:#cfcfcf; margin-bottom:16px; font-size:0.98rem; }

    form.contact-form { display:flex; flex-direction:column; gap:12px; }
    .field {
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,0.02);
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.02);
      transition: box-shadow .15s ease, border-color .15s ease, transform .08s ease;
    }
    .field:focus-within { border-color: rgba(124,92,255,0.9); box-shadow: 0 6px 22px rgba(124,92,255,0.06); transform: translateY(-2px); }
    .field svg { width:18px;height:18px; opacity:0.9; flex-shrink:0; color:#bdbdbd; fill:currentColor; }

    .field input, .field textarea {
      background: transparent;
      border: none;
      outline: none;
      color: #fff;
      width:100%;
      font-size:0.98rem;
      resize:vertical;
    }

    .small-note { font-size:0.82rem; color:#bdbdbd; margin-top:6px; }

    .btn-send {
      margin-top:8px;
      padding:12px 16px;
      border-radius:10px;
      background: linear-gradient(90deg,#7c5cff,#00f2ff);
      border:none;
      color:#08121a;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 8px 30px rgba(124,92,255,0.14);
      transition: transform .15s ease, box-shadow .15s ease, opacity .12s ease;
    }
    .btn-send:hover { transform: translateY(-3px); opacity:0.98; box-shadow: 0 12px 40px rgba(124,92,255,0.18); }

    /* toast */
    .toast {
      position:fixed;
      right:20px;
      bottom:20px;
      background: linear-gradient(180deg,#0b0b0b,#111);
      border: 1px solid rgba(124,92,255,0.14);
      color:#e8faff;
      padding:12px 16px;
      border-radius:10px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.6);
      transform: translateY(20px);
      opacity:0;
      transition: transform .28s cubic-bezier(.2,.9,.2,1), opacity .2s ease;
      z-index: 9999;
    }
    .toast.show { transform: translateY(0); opacity:1; }

    /* Publish request floating button */
    .publish-btn {
      position: fixed;
      right: 20px;
      bottom: 92px;
      z-index: 9998;
      width:56px;
      height:56px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg,#ff8ad6,#7c5cff);
      box-shadow: 0 10px 30px rgba(124,92,255,0.18);
      border: none;
      cursor:pointer;
      transition: transform .15s ease, box-shadow .2s ease, opacity .12s ease;
      color: #08121a;
    }
    .publish-btn:hover { transform: translateY(-4px); box-shadow: 0 18px 40px rgba(124,92,255,0.22); }
    .publish-btn .label {
      position:absolute;
      right:70px;
      background: rgba(11,11,11,0.9);
      color: white;
      padding:8px 12px;
      border-radius:10px;
      font-weight:600;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      transform: translateY(4px);
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      white-space:nowrap;
    }
    .publish-btn:focus .label,
    .publish-btn:hover .label { transform: translateY(0); opacity:1; }

    /* Floating nav container */
    #float-nav { position:fixed; top:50%; left:20px; transform:translateY(-50%); display:flex; flex-direction:column; gap:15px; z-index:999; }

    /* Responsive: hide float nav on small screens so it doesn't overlay content */
    @media (max-width:920px) {
      .contact-card { flex-direction:column; gap:18px; padding:20px; }
      .contact-right { width:100%; max-width:100%; }
      .hero h1 { font-size:2.6rem; }

      /* Hide left floating nav (touch devices) */
      #float-nav { display:none; }

      /* Reposition publish button a bit higher to avoid overlapping footers/CTA */
      .publish-btn { bottom: 110px; right: 18px; }
    }

  </style>
</head>
<body>
  {# --- Publish request: only show when not active and owner is viewing --- #}
  {% if not website.is_active and user.profile == website.user %}
    <button id="publishRequestBtn" class="publish-btn" aria-label="Request publish" title="Request publish">
      <span class="label" aria-hidden="true">Request publish</span>
      <i class="fas fa-paper-plane" aria-hidden="true"></i>
    </button>
  {% endif %}

  <section id="hero" class="hero">
    <img src="{{website.profile_pic.url}}" alt="Profile photo of Ziad Rabea">
    <h1>{{website.full_name}}</h1>
    <p>{{website.current_job}}</p>
    <a href="{{website.cv_url}}" download>Download CV</a>
    {% if user.profile == website.user %}
      <a href="/{{website.unique_name}}/edit">Update Info<i class="fas fa-brush"></i></a>
    {% endif %}
  </section>

  <div class="section-title">What I Do</div>
  <section id="services" class="services">
    {% for skill in website.skill_set.all %}
      <div class="card">{{skill.skill}}</div>
    {% endfor %}
  </section>

  <div class="section-title">Skills</div>
  <!-- NEW: structured skills with animated progress -->
  <section id="skills" class="skills" aria-label="Skills">
    {% for skill in website.skill_set.all %}
    <div class="skill" data-percent="{{skill.mastery}}">
      <div class="label-row">
        <div class="name">{{skill.skill}}</div>
        <div class="percent" aria-hidden="true">0%</div>
      </div>
      <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="bar" data-target="{{skill.mastery}}"></div>
      </div>
    </div>
    {% endfor %}
    {% if user.profile == website.user %}
      <a href="/{{website.unique_name}}/skills"> + Add/Remove Skill<i class="fas fa-brush"></i></a>
    {% endif %}
  </section>

  <div class="section-title">My Journey</div>
  <section id="timeline" class="timeline">
    {% for experience in website.experience_set.all %}
      <div class="milestone">{{experience.job}} | {{experience.employer}}</div>
    {% endfor %}
    {% if user.profile == website.user %}
      <a style="text-decoration: none; font-weight: bold;" href="/{{website.unique_name}}/work" class="milestone"> + | Add a new experience</a>
    {% endif %}
  </section>

  <div class="section-title">Projects</div>
  <section id="projects" class="projects">
    {% for project in website.project_set.all %}
      <div class="project-card"><strong>{{project.title}}</strong><br><br>{{project.about}}</div>
    {% endfor %}
    {% if user.profile == website.user %}
      <a style="text-decoration: none; color: whitesmoke;" href="/{{website.unique_name}}/projects" class="project-card"><strong>+ Add Project</strong><br><br>Create a new project</a>
    {% endif %}
  </section>

  <section class="cta" aria-labelledby="contact-title" style="padding-bottom: 10px;">
    <div class="section-title" id="contact-title" style="margin-top:40px;margin-bottom:18px;font-size:2rem;">Contact Me</div>

    <!-- Contact card -->
    <div class="contact-card" role="region" aria-label="Contact form">
      <div class="contact-left">
        <h3>Let's build something great</h3>
        <p class="lead">Tell me about your project or just say hi — I typically respond within a few days.</p>
        <p class="small-note">Prefer email? Send to <strong>{{website.email}}</strong></p>
      </div>

      <div class="contact-right">
        <form class="contact-form" id="contactForm" aria-label="Contact form">
          <label class="field" aria-hidden="false">
            <!-- user icon -->
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="M12 12a4 4 0 100-8 4 4 0 000 8zM3 20a9 9 0 0118 0H3z" fill="currentColor"/></svg>
            <input type="text" name="name" id="name" placeholder="Your name" required autocomplete="name" />
          </label>

          <label class="field">
            <!-- mail icon -->
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v.5L12 13 3 7.5V7zM21 9.2V17a2 2 0 01-2 2H5a2 2 0 01-2-2V9.2l8.5 4.5a2 2 0 001.5 0L21 9.2z" fill="currentColor"/></svg>
            <input type="email" name="email" id="email" placeholder="Your email" required autocomplete="email" />
          </label>

          <label class="field" style="align-items:flex-start;">
            <!-- message icon -->
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2v10z" fill="currentColor"/></svg>
            <textarea name="message" id="message" rows="4" placeholder="Your message" required></textarea>
          </label>

          <button type="submit" class="btn-send" aria-label="Send message">Send Message</button>
          <div class="small-note" aria-hidden="true">By sending you agree to be awesome and respectful ✨</div>
        </form>
      </div>
    </div>
  </section>

  <!-- Floating nav -->
  <div id="float-nav" aria-hidden="false">
    <div class="float-icon" data-target="hero" title="Top" role="button" aria-label="Top"></div>
    <div class="float-icon" data-target="services" title="Services" role="button" aria-label="Services"></div>
    <div class="float-icon" data-target="skills" title="Skills" role="button" aria-label="Skills"></div>
    <div class="float-icon" data-target="timeline" title="Journey" role="button" aria-label="Journey"></div>
    <div class="float-icon" data-target="projects" title="Projects" role="button" aria-label="Projects"></div>
  </div>

  <!-- toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Message sent — thanks! I'll get back to you shortly.</div>

  <script>
    /****************************
     * Helpers
     ****************************/
    function showToast(message, timeout = 2500) {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = message;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), timeout);
    }

    /* Get CSRF token from cookie (Django default) */
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    /****************************
     * Publish request button behavior
     * - Uses fetch POST to /{{website.unique_name}}/request_publish/
     * - Includes CSRF token header (Django)
     * - Shows toast on success/error
     ****************************/
    (function setupPublishButton(){
      const btn = document.getElementById('publishRequestBtn');
      if (!btn) return;

      btn.addEventListener('click', async () => {
        // disable to prevent double-click
        btn.disabled = true;
        btn.style.opacity = '0.9';

        const url = '/{{website.unique_name}}/publish/'; // expected backend endpoint
        const csrftoken = getCookie('csrftoken');

        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(csrftoken ? { 'X-CSRFToken': csrftoken } : {})
            },
            body: JSON.stringify({ website_id: {{ website.id }} })
          });

          if (res.ok) {
            showToast('Publish request sent — thanks! Check your dashboard.');
            // optionally change ui (disable or hide)
            btn.style.opacity = '0.6';
            btn.title = 'Request sent';
          } else {
            // backend didn't respond OK
            showToast('Could not send request — please try again or contact support.');
            btn.disabled = false;
          }
        } catch (err) {
          // network / CORS / endpoint missing
          console.error(err);
          showToast('Request failed. If your backend has no endpoint yet, implement POST ' + url);
          btn.disabled = false;
        }
      });
    })();


    /****************************
     * float nav behavior
     * - Use IntersectionObserver for each section so active state is stable and not single-pixel sensitive
     ****************************/
    (function setupFloatNav(){
      const icons = Array.from(document.querySelectorAll('.float-icon'));
      const map = {};
      icons.forEach(i => map[i.dataset.target] = i);

      // click behavior (smooth)
      icons.forEach(icon => {
        icon.addEventListener('click', () => {
          const target = document.getElementById(icon.dataset.target) || document.querySelector('.' + icon.dataset.target);
          if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
        icon.tabIndex = 0;
        icon.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); icon.click(); }
        });
      });

      // IntersectionObserver options tuned to center area of viewport
      const io = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const id = entry.target.id || entry.target.className;
          const icon = map[entry.target.id];
          if (!icon) return;
          if (entry.isIntersecting) {
            // set only this icon active
            icons.forEach(ic => ic.classList.remove('active'));
            icon.classList.add('active');
          }
        });
      }, { root: null, rootMargin: '-40% 0px -40% 0px', threshold: 0.01 });

      // Observe each section that has an icon
      Object.keys(map).forEach(k => {
        const sec = document.getElementById(k) || document.querySelector('.' + k);
        if (sec) io.observe(sec);
      });
    })();


    /****************************
     * Progress bars animation on scroll (per-skill observer)
     * - Observe each .skill individually so they animate reliably when entering viewport
     ****************************/
    (function setupSkillObservers(){
      const skills = document.querySelectorAll('.skill');
      if (!skills || skills.length === 0) return;

      // animate numeric counter
      function animateCount(elPercentNode, from, to, duration = 900) {
        const start = performance.now();
        function step(now) {
          const t = Math.min(1, (now - start) / duration);
          // smooth easeOutCubic
          const eased = 1 - Math.pow(1 - t, 3);
          const current = Math.round(from + (to - from) * eased);
          elPercentNode.textContent = current + '%';
          if (t < 1) requestAnimationFrame(step);
          else elPercentNode.textContent = to + '%';
        }
        requestAnimationFrame(step);
      }

      const skillObserver = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (!entry.isIntersecting) return;
          const skillEl = entry.target;
          const bar = skillEl.querySelector('.progress .bar');
          if (!bar || bar.classList.contains('animated')) { obs.unobserve(skillEl); return; }

          const target = parseInt(bar.dataset.target || 0, 10);
          // set width -> CSS transition handles smoothness
          // small timeout to ensure layout flush for smoother animation on some browsers
          requestAnimationFrame(() => {
            bar.style.width = target + '%';
            bar.style.setProperty('--target-offset', target + '%');
            bar.classList.add('bar-filled');
            bar.classList.add('animated');
          });

          // accessibility
          const progress = bar.closest('.progress');
          if (progress) progress.setAttribute('aria-valuenow', String(target));

          // animate percent text
          const percentNode = skillEl.querySelector('.percent');
          animateCount(percentNode, 0, target, 700 + Math.round(target * 5));

          obs.unobserve(skillEl);
        });
      }, { threshold: 0.45 });

      skills.forEach(s => skillObserver.observe(s));
    })();


    /****************************
     * Contact form behavior (kept and unchanged)
     ****************************/
    const contactForm = document.getElementById('contactForm');
    const toast = document.getElementById('toast');

    contactForm && contactForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const name = contactForm.querySelector('#name').value.trim();
      const email = contactForm.querySelector('#email').value.trim();
      const message = contactForm.querySelector('#message').value.trim();
      if (!name || !email || !message) {
        toast.textContent = 'Please complete all fields before sending.';
        toast.classList.add('show');
        setTimeout(()=> toast.classList.remove('show'), 2500);
        return;
      }

      toast.textContent = 'Message sent — thanks! I\'ll get back to you shortly.';
      toast.classList.add('show');

      setTimeout(()=> {
        toast.classList.remove('show');
        contactForm.reset();
      }, 1800);
    });

  </script>

</body>
</html>
